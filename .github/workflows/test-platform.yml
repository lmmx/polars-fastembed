name: Test platform

on:
  workflow_call:
    inputs:
      python-versions:
        required: true
        type: string
      runner:
        required: true
        type: string
      os:
        required: true
        type: string
      target:
        required: true
        type: string
      features:
        required: false
        type: string
        default: ""

jobs:
  test:
    runs-on: ${{ inputs.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJson(inputs.python-versions) }}
    defaults:
      run:
        working-directory: polars-fastembed
    steps:
      - uses: actions/checkout@v4

      - name: Install just
        uses: taiki-e/install-action@64adfd9e935fa438859b9e080fd026720b2ba070

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1
        with:
          workspaces: polars-fastembed
          key: ${{ inputs.os }}-${{ inputs.target }}-${{ matrix.python-version }}

      - name: Setup platform dependencies (Linux)
        if: inputs.os == 'linux'
        working-directory: .
        run: |
          sudo apt-get update -y
          sudo apt-get install -y pkg-config libssl-dev libopenblas-dev

      - name: Setup platform dependencies (macOS)
        if: inputs.os == 'macos'
        run: brew install openblas

      - name: Setup platform dependencies (Windows) - OpenBLAS
        if: inputs.os == 'windows'
        shell: pwsh
        run: |
            Add-Content -Path $env:GITHUB_ENV -Value "VCPKG_ROOT=$env:VCPKG_INSTALLATION_ROOT"
            vcpkg install openblas:x64-windows lapack:x64-windows
            vcpkg integrate install

      - name: Create venv and install dependencies
        run: uv sync --group test --extra cpu

      - name: Build and install extension
        run: uv run --no-sync --frozen maturin develop --release ${{ inputs.features }}

      - name: Debug ORT library
        if: inputs.os == 'linux'
        run: |
          ORT_PATH=$(uv run python -c "import polars_fastembed_cpu as l; print(l.get_ort_lib_path())")
          echo "Checking $ORT_PATH"
          ldd "$ORT_PATH" || true
          file "$ORT_PATH"

      - name: Run tests
        shell: bash
        run: |
          if [ "${{ inputs.os }}" = "linux" ]; then
            export ORT_DYLIB_PATH=$(uv run python -c "import polars_fastembed_cpu as l; print(l.get_ort_lib_path())")
            echo "ORT_DYLIB_PATH=$ORT_DYLIB_PATH"
          fi
          uv run --no-sync --frozen pytest -s -v
