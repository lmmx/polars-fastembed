name: Build ORT Provider Packages

on:
  push:
    branches: [main, master]
    tags: ["*"]
  pull_request:
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy Release"]
    types:
      - completed

jobs:
  build-cpu:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x64
            ort_archive: onnxruntime-linux-x64-1.23.0.tgz
            lib_pattern: "libonnxruntime*.so*"
            wheel_plat: manylinux_2_17_x86_64
            can_upx: false
          - os: ubuntu-24.04
            platform: linux-aarch64
            ort_archive: onnxruntime-linux-aarch64-1.23.0.tgz
            lib_pattern: "libonnxruntime*.so*"
            wheel_plat: manylinux_2_17_aarch64
            can_upx: false
          - os: macos-14
            platform: osx-arm64
            ort_archive: onnxruntime-osx-arm64-1.23.0.tgz
            lib_pattern: "libonnxruntime*.dylib"
            wheel_plat: macosx_14_0_arm64
            can_upx: true
          - os: macos-14
            platform: osx-x86_64
            ort_archive: onnxruntime-osx-x86_64-1.23.0.tgz
            lib_pattern: "libonnxruntime*.dylib"
            wheel_plat: macosx_14_0_x86_64
            can_upx: true
          - os: windows-latest
            platform: win-x64
            ort_archive: onnxruntime-win-x64-1.23.0.zip
            lib_pattern: "*onnx*.dll"
            wheel_plat: win_amd64
            can_upx: false # Gives CantPackException: GUARD_CF enabled PE files are not supported

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - name: Install just
        uses: taiki-e/install-action@64adfd9e935fa438859b9e080fd026720b2ba070 # tag=just

      - name: Install mise
        uses: taiki-e/install-action@a35b65432737a0a6ffe8864f12763fb6c19e4f7a # tag=mise

      - name: Install upx via mise
        if: matrix.can_upx && runner.os != 'macOS'
        run: mise use upx

      - name: Install upx via Homebrew (macOS only)
        if: matrix.can_upx && runner.os == 'macOS'
        run: brew install upx

      - uses: astral-sh/setup-uv@v7

      - name: Download ORT
        run: just _download-ort-cpu ${{ matrix.platform }} ${{ matrix.ort_archive }} "${{ matrix.lib_pattern }}"

      - name: Compress libs with UPX
        if: matrix.can_upx
        shell: bash
        run: just compress-libs-upx polars-fastembed-cpu/python/polars_fastembed_cpu/libs

      - name: Build wheel
        run: just build-ort-cpu

      - name: Rename wheel with platform tag
        shell: bash
        run: just rename-wheel polars-fastembed-cpu ${{ matrix.wheel_plat }}

      - name: Check wheel size under 100MB
        shell: bash
        run: just check-wheel-size polars-fastembed-cpu/dist

      - name: Upload wheel
        uses: actions/upload-artifact@v5
        with:
          name: wheels-cpu-${{ matrix.platform }}
          path: polars-fastembed-cpu/dist/*.whl

  # CUDA: build from committed libs (Linux x64 sm_86 only for now)
  # CUDA: Linux uses committed libs, Windows downloads from Microsoft
  build-cuda:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x64-gpu
            wheel_plat: manylinux_2_17_x86_64
            download_ort: false  # Use committed libs
            can_upx: false       # Already compressed
          # - os: windows-latest
          #   platform: win-x64-gpu
          #   ort_archive: onnxruntime-win-x64-gpu-1.23.0.zip
          #   lib_pattern: "*onnx*.dll"
          #   wheel_plat: win_amd64
          #   download_ort: true
          #   can_upx: false # Gives CantPackException: GUARD_CF enabled PE files are not supported

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - name: Install just
        uses: taiki-e/install-action@64adfd9e935fa438859b9e080fd026720b2ba070 # tag=just

      - name: Install mise
        uses: taiki-e/install-action@a35b65432737a0a6ffe8864f12763fb6c19e4f7a # tag=mise
        if: matrix.can_upx

      - name: Install upx via mise
        if: matrix.can_upx
        run: mise use upx

      - uses: astral-sh/setup-uv@v7

      - name: Download ORT
        if: matrix.download_ort
        run: just _download-ort-cuda ${{ matrix.platform }} ${{ matrix.ort_archive }} "${{ matrix.lib_pattern }}"

      - name: Compress libs with UPX
        if: matrix.can_upx
        shell: bash
        run: just compress-libs-upx polars-fastembed-cuda/python/polars_fastembed_cuda/libs

      - name: Build wheel
        run: just build-ort-cuda

      - name: Rename wheel with platform tag
        shell: bash
        run: just rename-wheel polars-fastembed-cuda ${{ matrix.wheel_plat }}

      - name: Check wheel size under 100MB
        shell: bash
        run: just check-wheel-size polars-fastembed-cuda/dist

      - name: Upload wheel
        uses: actions/upload-artifact@v5
        with:
          name: wheels-cuda-${{ matrix.platform }}
          path: polars-fastembed-cuda/dist/*.whl

  test-cpu:
    needs: [build-cpu]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x64
          - os: macos-14
            platform: osx-arm64
          # - os: macos-14
          #   platform: osx-x86_64
          - os: windows-latest
            platform: win-x64

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - name: Install OpenBLAS (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libopenblas-dev

      - name: Install OpenBLAS (macOS)
        if: runner.os == 'macOS'
        run: brew install openblas

      - name: Install just
        uses: taiki-e/install-action@64adfd9e935fa438859b9e080fd026720b2ba070 # tag=just

      - uses: astral-sh/setup-uv@v7

      - uses: actions/download-artifact@v7
        with:
          name: wheels-cpu-${{ matrix.platform }}
          path: dist-cpu

      - name: Test CPU provider wheel
        run: just test-ort-cpu dist-cpu

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1
        with:
          workspaces: polars-fastembed
          key: ${{ matrix.os }}-${{ matrix.platform }}

      - name: Integration test with polars-fastembed
        working-directory: polars-fastembed
        shell: bash
        run: |
          uv venv
          ls -la ../dist-cpu/
          uv pip install ../dist-cpu/*.whl
          uv pip list
          uv run maturin develop --uv
          uv run python -c "import polars_fastembed as pf; pf.register_model('SnowflakeArcticEmbedXSQ')"

  test-cuda:
    needs: [build-cuda]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04
            platform: linux-x64-gpu
          # - os: windows-latest
          #   platform: win-x64-gpu

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6

      - name: Install OpenBLAS (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libopenblas-dev

      - name: Install OpenBLAS (macOS)
        if: runner.os == 'macOS'
        run: brew install openblas

      - name: Install just
        uses: taiki-e/install-action@64adfd9e935fa438859b9e080fd026720b2ba070 # tag=just

      - uses: astral-sh/setup-uv@v7

      - uses: actions/download-artifact@v7
        with:
          name: wheels-cuda-${{ matrix.platform }}
          path: dist-cuda

      - name: Test CUDA provider wheel
        run: just test-ort-cuda dist-cuda

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1
        with:
          workspaces: polars-fastembed
          key: ${{ matrix.os }}-${{ matrix.platform }}

      - name: Integration test with polars-fastembed
        working-directory: polars-fastembed
        run: |
          uv venv
          uv pip install ../dist-cuda/*.whl
          uv run maturin develop --uv
          uv run python -c "import polars_fastembed as pf; pf.register_model('SnowflakeArcticEmbedXSQ')"

  release-providers:
    needs: [test-cpu, test-cuda]
    runs-on: ubuntu-latest
    environment: pypi
    if: ${{ startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_run' }}
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/download-artifact@v7
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
